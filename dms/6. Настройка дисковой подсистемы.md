2. Настройка дисковой подсистемы

- a) На SRV-HQ настройте зеркалируемый LVM том
    - a. Используйте два неразмеченных жестких диска.
    - b. Настройте автоматическое монтирование логического тома.
    - c. Точка монтирования /opt/data.
- b) На SRV-BR сконфигурируйте stripped LVM том.
    - a. Используйте два неразмеченных жестких диска.
    - b. Настройте автоматическое монтирование тома.
    - c. Обеспечьте шифрование тома средствами dm-crypt. Диск должен монтироваться при загрузке ОС без запроса пароля.
    - d. Точка монтирования /opt/data.

### Выполнение:

#### SRV-HQ:

- Используем два неразмеченных жёстких диска: **sdb** и **sdc:**

![Pasted image 20240212193041](https://github.com/e1mky/dms/assets/102690802/5215ca5b-6098-428e-a49b-dabbbcad494d)


- создаём раздел на диске **sdb:**

```
gdisk /dev/sdb
```

- 1 - Создаём пустую **GUID partition table** - нажимаем "**o**" -> "**y**", чтобы удалить все разделы и создать **GPT запись**;
- 2 - Создаём первый и единственный раздел на весь диск. Нажимаем "**n**" -> 1 -> '**enter**' -> '**enter**' -> "**8e00**" - указываем, что данный раздел относится к **LVM**;
- 3 - "**p**" - Теперь можно просмотреть то, что получилось.

![Pasted image 20240212193054](https://github.com/e1mky/dms/assets/102690802/417c9864-a726-4917-a652-1993ff4bb751)


- после чего нажимаем "**w**" -> "**Y**" - подтверждаем и записываем изменения на диск:

![Pasted image 20240212193105](https://github.com/e1mky/dms/assets/102690802/5def3a67-d815-4b7c-a821-2558a16bc5fa)


- аналогичным образом создаём раздел на диске **sdc,** результат:

![Pasted image 20240212193118](https://github.com/e1mky/dms/assets/102690802/555744e6-f88a-4bb3-9624-7a672fae45d1)


- Инициализируем диски для работы с **LVM**:

```
pvcreate /dev/sd{b,c}1
```

где:

**/dev/sd{b,c}1** - это разделы блочных устройств: **sdb** и **sdc**;

- Создаём и добавляем диски в группу **vg01**:

```
vgcreate vg01 /dev/sd{b,c}1
```

где:

**vg01** - имя группы;

**/dev/sd{b,c}1** - это разделы блочных устройств: sdb и sdc, ранее проинициализированные для работы с LVM;

- Создаём логический том в режиме **зеркалирования** (raid1):

```
lvcreate -l 100%FREE -n lvmirror -m1 vg01
```

где:

**-l 100%FREE** - используется все свободное пространство группы **vg01**;

**-n lvmirror** - задаётся имя логическому тому "**lvmirror**";

**-m1** - создает зеркальный логический том с "**зеркальными**" копиями;

**vg01** - имя группы созданной ранее, в которой создаётся логический том с именем **lvmirror**.

- Проверяем:

![Pasted image 20240212193134](https://github.com/e1mky/dms/assets/102690802/136d3867-cbdb-4962-a7f1-63616e3686f0)


- создаём файловую систему на логическом томе **lvmirror**:

```
mkfs.ext4 /dev/vg01/lvmirror
```

- Монтируем логический диск в "**/opt/data**":
    - создаём директорию для монтирования:

```
mkdir /opt/data
```

- - добавляем запись в файл **/etc/fstab** для автоматического монтирования логического тома:

```
echo "UUID=$(blkid -s UUID -o value /dev/vg01/lvmirror) /opt/data ext4 defaults 1 2" | tee -a /etc/fstab
```

- выполняем монтирование:

```
mount -av
```

![Pasted image 20240212193148](https://github.com/e1mky/dms/assets/102690802/13d630c3-3733-4fd9-88f4-033053595550)


- Проверяем:

![Pasted image 20240212193200](https://github.com/e1mky/dms/assets/102690802/98b9ecd9-ac9f-4b26-b515-99661c8c183c)


#### SRV-BR:

- Используем два неразмеченных жёстких диска: **sdb** и **sdc**
- Создаём разделы на двух подключённых дисках "**sdb** и **sdc**" аналогично как и на **SRV-HQ** - через **gdisk,** результат:

![Pasted image 20240212193222](https://github.com/e1mky/dms/assets/102690802/b9a32532-6e24-4703-aca6-319a476bb8d0)


- Аналогично **SRV-HQ** добавляем диски в **LVM** и создаём группу из двух дисков:

```
pvcreate /dev/sd{b,c}1
```

```
vgcreate vg01 /dev/sd{b,c}1
```

- Создаём **striped LVM** том с именем "**lvstriped**":

```
lvcreate -i2 -l 100%FREE -n lvstreped vg01
```

где:

**-i2** - количество полосок (для полосок необходимо использовать диск);

**-l 100%FREE** - используется все свободное пространство группы **vg01**;

**-n lvstreped** - задаётся имя логическому тому "**lvstreped**";

**vg01** - имя группы созданной ранее, в которой создаётся логический том с именем **lvstreped**.

- Проверяем:

![Pasted image 20240212193233](https://github.com/e1mky/dms/assets/102690802/c3e8f801-cc3b-4c67-8402-993b82f6e7b6)


- создаём файловую систему на логическом томе **lvstreped**:

```
mkfs.ext4 /dev/vg01/lvstreped
```

- Обеспечиваем шифрование тома средствами **dm-crypt**:
    - Создаём ключевой файл:

```
dd if=/dev/urandom of=/etc/keys/enc.key bs=1 count=4096
```

- - Выполняем шифрование тома "**lvstreped**" с использованием **ключевого файла** вместо пароля, указывая путь до логического тома и путь до созданного ключа:

```
cryptsetup luksFormat /dev/vg01/lvstreped /etc/keys/enc.key
```

- - - после ввода данной команды необходимо подтверждение - "**YES**":

![Pasted image 20240212193257](https://github.com/e1mky/dms/assets/102690802/48ebffb6-10fd-4b6e-b977-f5406b7dc04c)


- - Далее необходимо открыть только что зашифрованный логический том при помощи созданного ключа, чтобы он появился в списке блочных устройств в выводе команды "**lsblk**":

```
cryptsetup luksOpen -d /etc/keys/enc.key /dev/vg01/lvstreped lvstreped
```

где:

**-d /etc/keys/enc.key** - путь до ключа, которым был зашифрован логический том **lvstreped;**

**/dev/vg01/lvstreped** - путь до логического тома, с которого необходимо снять шифрование;

**lvstreped** - произвольное имя, которое будет назначено для разшифрованного тома, и должно появиться в выводе команды **lsblk**.

![Pasted image 20240212193314](https://github.com/e1mky/dms/assets/102690802/0ee680a1-4eea-4c0c-ab8b-26d051e6683c)


- - Задаём файловую систему на только расшифрованном томе который находится в директории **/dev/mapper/**:

```
mkfs.ext4 /dev/mapper/lvstreped
```

- - Монтируем логический том в "**/opt/data**":
        - создаём директорию для монтирования:

```
mkdir /opt/data
```

- - - добавляем запись в файл **/etc/fstab** для автоматического монтирования логического тома:

```
echo "UUID=$(blkid -s UUID -o value /dev/mapper/lvstreped) /opt/data ext4 defaults 0 0" | tee -a /etc/fstab
```

_P.S: **UUID** указывается **расшифрованного (открытого)** логического тома._

- - выполняем монтирование:

```
mount -av
```

![Pasted image 20240212193327](https://github.com/e1mky/dms/assets/102690802/8799944f-190b-4ed6-b88e-9aa4ee3f1f3a)


- Обеспечиваем монтирование логического тома при загрузке ОС без ввода пароля:

```
echo "lvstreped UUID=$(blkid -s UUID -o value /dev/vg01/lvstreped) /etc/keys/enc.key luks" | tee -a /etc/crypttab
```

_P.S: UUID указывается **зашифрованного (закрытого)** логического тома, чтобы во время загрузки ОС до монтирования выполнялось его открытие при помощи ключа._

- Проверяем:
    - выполнить перезагрузку **reboot**, запуск ОС должен произости без какой либо ошибки на стадии загрузки, после чего проверить примонтированные устройства:

![Pasted image 20240212193342](https://github.com/e1mky/dms/assets/102690802/8ce8b0a3-858a-4bc4-948f-a30ea5f3eb3b)

